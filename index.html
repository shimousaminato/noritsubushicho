<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‰„é“çµŒçœŒå€¤ãƒãƒƒãƒ— (GASé€£æºç‰ˆ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        body {
            font-family: "Inter", sans-serif;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’èª¿æ•´ */
        #lineListContainer {
            max-height: 65vh;
            overflow-y: auto;
        }
    </style>
    
    <!-- GASé€£æºã®ãŸã‚ã®JavaScript -->
    <script type="module">
        // =========================================================================
        // ğŸš¨ ğŸŒŸ ğŸŒŸ æœ€é‡è¦: ã“ã“ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGoogle Apps Scriptã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ ğŸŒŸ ğŸŒŸ ğŸš¨
        // ä¾‹: 'https://script.google.com/macros/s/AKfycb.../exec'
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwGEI-eS52XUA0omMD2Y-nSKzKgKxHmPAcfdhnBY5inL0Hl99apKSlMdg9ZLUOaFPeFKA/exec'; 
        // =========================================================================
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ä»£ã‚ã‚Šã«ã€ã“ã“ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚ŒãŸå›ºæœ‰IDã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        // ã“ã‚Œã«ã‚ˆã‚Šã€Firebaseã®èªè¨¼ãªã—ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã§ãã¾ã™ã€‚
        let userId = localStorage.getItem('railroad_map_user_id');
        if (!userId) {
            userId = crypto.randomUUID();
            localStorage.setItem('railroad_map_user_id', userId);
        }
        
        // ------------------------------------
        // ãƒ€ãƒŸãƒ¼ã®æ—¥æœ¬é‰„é“è·¯ç·šãƒ‡ãƒ¼ã‚¿
        // ------------------------------------
        const dummyRailroadData = {
            "type": "FeatureCollection",
            "features": [ 
                // JRåŒ—æµ·é“
                { "properties": { "N02_005": "å‡½é¤¨æœ¬ç·š", "N02_004": "JRåŒ—æµ·é“", "stations": ["å‡½é¤¨", "é•·ä¸‡éƒ¨", "å°æ¨½", "æœ­å¹Œ"] } },
                
                // JRæ±æ—¥æœ¬
                { "properties": { "N02_005": "æ±åŒ—æ–°å¹¹ç·š", "N02_004": "JRæ±æ—¥æœ¬", "stations": ["æ±äº¬", "ä»™å°", "ç››å²¡", "æ–°é’æ£®"] } },
                { "properties": { "N02_005": "å±±æ‰‹ç·š", "N02_004": "JRæ±æ—¥æœ¬", "stations": ["æ±äº¬", "å“å·", "æ¸‹è°·", "æ–°å®¿", "æ± è¢‹"] } },
                { "properties": { "N02_005": "äº¬æµœæ±åŒ—ç·š", "N02_004": "JRæ±æ—¥æœ¬", "stations": ["å¤§å®®", "ä¸Šé‡", "æ¨ªæµœ", "å¤§èˆ¹"] } },
                { "properties": { "N02_005": "ä¸­å¤®æœ¬ç·š", "N02_004": "JRæ±æ—¥æœ¬", "stations": ["æ±äº¬", "å…«ç‹å­", "ç”²åºœ", "æ¾æœ¬"] } },
                { "properties": { "N02_005": "åŸ¼äº¬ç·š", "N02_004": "JRæ±æ—¥æœ¬", "stations": ["å¤§å´", "æ–°å®¿", "å¤§å®®", "å·è¶Š"] } },

                // JRæ±æµ·
                { "properties": { "N02_005": "æ±æµ·é“æ–°å¹¹ç·š", "N02_004": "JRæ±æµ·", "stations": ["æ±äº¬", "åå¤å±‹", "æ–°å¤§é˜ª"] } },
                { "properties": { "N02_005": "æ±æµ·é“æœ¬ç·š", "N02_004": "JRæ±æµ·", "stations": ["ç†±æµ·", "é™å²¡", "æµœæ¾", "è±Šæ©‹"] } },
                
                // JRè¥¿æ—¥æœ¬
                { "properties": { "N02_005": "å±±é™½æ–°å¹¹ç·š", "N02_004": "JRè¥¿æ—¥æœ¬", "stations": ["æ–°å¤§é˜ª", "å²¡å±±", "åºƒå³¶", "åšå¤š"] } },
                { "properties": { "N02_005": "å¤§é˜ªç’°çŠ¶ç·š", "N02_004": "JRè¥¿æ—¥æœ¬", "stations": ["å¤§é˜ª", "å¤©ç‹å¯º", "äº¬æ©‹", "è¥¿ä¹æ¡"] } },
                { "properties": { "N02_005": "åŒ—é™¸æœ¬ç·š", "N02_004": "JRè¥¿æ—¥æœ¬", "stations": ["ç±³åŸ", "æ•¦è³€", "é‡‘æ²¢"] } },

                // JRå››å›½ (é«˜çŸ¥é–¢é€£è·¯ç·šã‚’å……å®Ÿ)
                { "properties": { "N02_005": "åœŸè®ƒç·š", "N02_004": "JRå››å›½", "stations": ["é«˜çŸ¥", "çªªå·", "é˜¿æ³¢æ± ç”°", "ç´å¹³"] } },
                { "properties": { "N02_005": "äºˆè®ƒç·š", "N02_004": "JRå››å›½", "stations": ["é«˜æ¾", "æ¾å±±", "å®‡å’Œå³¶"] } },
                { "properties": { "N02_005": "äºˆåœŸç·š", "N02_004": "JRå››å›½", "stations": ["çªªå·", "æ±Ÿå·å´", "å®‡å’Œå³¶"] } },

                // JRä¹å·
                { "properties": { "N02_005": "ä¹å·æ–°å¹¹ç·š", "N02_004": "JRä¹å·", "stations": ["åšå¤š", "ç†Šæœ¬", "é¹¿å…å³¶ä¸­å¤®"] } },
                { "properties": { "N02_005": "é¹¿å…å³¶æœ¬ç·š", "N02_004": "JRä¹å·", "stations": ["é–€å¸æ¸¯", "åšå¤š", "ç†Šæœ¬", "å…«ä»£"] } },

                // ç§é‰„ãƒ»ãã®ä»–
                { "properties": { "N02_005": "æ±æ­¦ä¼Šå‹¢å´ç·š", "N02_004": "æ±æ­¦é‰„é“", "stations": ["æµ…è‰", "åŒ—åƒä½", "ä¹…å–œ", "ä¼Šå‹¢å´"] } },
                { "properties": { "N02_005": "è¥¿æ­¦æ± è¢‹ç·š", "N02_004": "è¥¿æ­¦é‰„é“", "stations": ["æ± è¢‹", "æ‰€æ²¢", "é£¯èƒ½"] } },
                { "properties": { "N02_005": "æ±æ€¥æ±æ¨ªç·š", "N02_004": "æ±æ€¥é›»é‰„", "stations": ["æ¸‹è°·", "ä¸­ç›®é»’", "æ¨ªæµœ", "å…ƒç”ºãƒ»ä¸­è¯è¡—"] } },
                { "properties": { "N02_005": "å°ç”°æ€¥å°ç”°åŸç·š", "N02_004": "å°ç”°æ€¥é›»é‰„", "stations": ["æ–°å®¿", "ç”ºç”°", "å°ç”°åŸ", "ç®±æ ¹æ¹¯æœ¬"] } },
                { "properties": { "N02_005": "è¿‘é‰„å¥ˆè‰¯ç·š", "N02_004": "è¿‘ç•¿æ—¥æœ¬é‰„é“", "stations": ["å¤§é˜ªé›£æ³¢", "é¶´æ©‹", "æ±èŠ±åœ’", "è¿‘é‰„å¥ˆè‰¯"] } },
                { "properties": { "N02_005": "åé‰„åå¤å±‹æœ¬ç·š", "N02_004": "åå¤å±‹é‰„é“", "stations": ["è±Šæ©‹", "çŸ¥ç«‹", "åé‰„åå¤å±‹", "åé‰„å²é˜œ"] } },
                { "properties": { "N02_005": "è¥¿é‰„å¤©ç¥å¤§ç‰Ÿç”°ç·š", "N02_004": "è¥¿æ—¥æœ¬é‰„é“", "stations": ["ç¦å²¡å¤©ç¥", "è¥¿é‰„ä¹…ç•™ç±³", "å¤§ç‰Ÿç”°"] } },
                { "properties": { "N02_005": "ç´å¹³ç·š", "N02_004": "é«˜æ¾ç´å¹³é›»æ°—é‰„é“", "stations": ["é«˜æ¾ç¯‰æ¸¯", "ç“¦ç”º", "ä»ç”Ÿå±±", "ç´é›»ç´å¹³"] } },
            ]
        };
        
        // è·¯ç·šå…¨ä½“ã®çŠ¶æ…‹ã®å®šæ•°
        const RIDE_STATUS = {
            NOT_RIDDEN: 0,
            RIDDEN: 1,
            COMPLETED: 2
        };
        const STATUS_LABELS = {
            [RIDE_STATUS.NOT_RIDDEN]: "æœªä¹—è»Š",
            [RIDE_STATUS.RIDDEN]: "ä¹—è»Šæ¸ˆã¿",
            [RIDE_STATUS.COMPLETED]: "å®Œä¹—æ¸ˆã¿"
        };
        const STATUS_COLORS = {
            [RIDE_STATUS.NOT_RIDDEN]: "text-gray-500 bg-gray-100 border-gray-300 hover:bg-gray-200",
            [RIDE_STATUS.RIDDEN]: "text-blue-700 bg-blue-100 border-blue-400 hover:bg-blue-200",
            [RIDE_STATUS.COMPLETED]: "text-emerald-700 bg-emerald-100 border-emerald-400 hover:bg-emerald-200"
        };
        
        // é§…å˜ä½ã®åˆ©ç”¨å›æ•°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å®šæ•°
        const USAGE_STATUS = {
            NOT_ALIGHTED: 0,
            ONCE: 1,
            LESS_THAN_TEN: 2,
            TEN_OR_MORE: 3
        };
        const USAGE_LABELS = {
            [USAGE_STATUS.NOT_ALIGHTED]: "æœªé™è»Š",
            [USAGE_STATUS.ONCE]: "åˆ©ç”¨1å›",
            [USAGE_STATUS.LESS_THAN_TEN]: "10å›æœªæº€",
            [USAGE_STATUS.TEN_OR_MORE]: "10å›ä»¥ä¸Š"
        };
        const USAGE_COLORS = {
            [USAGE_STATUS.NOT_ALIGHTED]: "text-gray-500 bg-gray-100",
            [USAGE_STATUS.ONCE]: "text-yellow-700 bg-yellow-100",
            [USAGE_STATUS.LESS_THAN_TEN]: "text-blue-700 bg-blue-100",
            [USAGE_STATUS.TEN_OR_MORE]: "text-red-700 bg-red-100"
        };
        
        // é§…å˜ä½ã®åˆ©ç”¨å›æ•°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¯¾å¿œã™ã‚‹ãƒã‚¤ãƒ³ãƒˆ
        const USAGE_POINTS = {
            [USAGE_STATUS.NOT_ALIGHTED]: 0,
            [USAGE_STATUS.ONCE]: 1,
            [USAGE_STATUS.LESS_THAN_TEN]: 2,
            [USAGE_STATUS.TEN_OR_MORE]: 3
        };
        

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // æ§‹é€ : { [lineName]: { overallStatus: number, stations: { [stationName]: number } } }
        let lineStatuses = {}; 
        let isSaving = false;
        let groupedLines = {}; // ä¼šç¤¾åã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸè·¯ç·šãƒ‡ãƒ¼ã‚¿

        // ------------------------------------
        // è·¯ç·šãƒ‡ãƒ¼ã‚¿ã‚’ä¼šç¤¾åã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        // ------------------------------------
        const groupLinesByCompany = () => {
            const groups = {};
            dummyRailroadData.features.forEach(feature => {
                const company = feature.properties.N02_004;
                if (!groups[company]) {
                    groups[company] = [];
                }
                groups[company].push(feature);
            });
            return groups;
        };

        // ------------------------------------
        // 1. GASãƒ‡ãƒ¼ã‚¿æ“ä½œ (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€šä¿¡)
        // ------------------------------------
        
        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
        const saveDataToGas = async (newStatuses) => {
            if (GAS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_DEPLOYMENT_URL_HERE') {
                console.error("GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚");
                alertMessage("ã‚¨ãƒ©ãƒ¼: GAS URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚", 'bg-red-500');
                return;
            }
            if (isSaving) {
                console.warn("ç¾åœ¨ä¿å­˜ä¸­ã§ã™ã€‚");
                return;
            }
            
            isSaving = true;
            
            // ä¿å­˜æ™‚ã¯JSONæ–‡å­—åˆ—ã«å¤‰æ›
            const payload = {
                userId: userId,
                lineStatusesJson: JSON.stringify(newStatuses)
            };
            
            try {
                // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’å®Ÿè£…ã—ã¦å†è©¦è¡Œ
                let lastError = null;
                for (let i = 0; i < 3; i++) { // æœ€å¤§3å›è©¦è¡Œ
                    try {
                        const response = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }
                        
                        alertMessage("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", 'bg-emerald-500');
                        isSaving = false;
                        return; // æˆåŠŸ
                    } catch (e) {
                        lastError = e;
                        const delay = Math.pow(2, i) * 1000; // 1ç§’, 2ç§’, 4ç§’
                        if (i < 2) { // æœ€å¾Œã®è©¦è¡Œã§ã¯å¾…ãŸãªã„
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                // 3å›è©¦è¡Œå¤±æ•—
                throw lastError; 

            } catch (e) {
                console.error("Error saving ride data to GAS:", e);
                alertMessage(`ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, 'bg-red-500');
            } finally {
                isSaving = false;
            }
        };

        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆGETãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
        const setupDataListener = async () => {
            if (GAS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_DEPLOYMENT_URL_HERE') {
                // URLæœªè¨­å®šã®å ´åˆã‚‚UIè¡¨ç¤ºã‚’ç¶™ç¶šã™ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿
                console.error("GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚");
                lineStatuses = {};
                updateUI();
                document.getElementById('loadingIndicator').classList.add('hidden');
                return;
            }

            try {
                 // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’å®Ÿè£…ã—ã¦å†è©¦è¡Œ
                let lastError = null;
                let data = null;
                
                for (let i = 0; i < 3; i++) { // æœ€å¤§3å›è©¦è¡Œ
                    try {
                        const url = `${GAS_URL}?userId=${userId}`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }
                        
                        data = await response.json();
                        break; // æˆåŠŸ
                    } catch (e) {
                        lastError = e;
                        const delay = Math.pow(2, i) * 1000; // 1ç§’, 2ç§’, 4ç§’
                        if (i < 2) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                if (!data) throw lastError; // 3å›è©¦è¡Œå¤±æ•—

                let loadedStatuses = {};
                if (data.lineStatusesJson) {
                    try {
                        // JSONæ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
                        loadedStatuses = JSON.parse(data.lineStatusesJson);
                    } catch(e) {
                        console.error("Failed to parse ride data from GAS:", e);
                    }
                }
                
                lineStatuses = loadedStatuses; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                updateUI(); // UIå…¨ä½“ã‚’æ›´æ–°

            } catch (error) {
                console.error("GASãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:", error);
                alertMessage(`ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚${error.message}`, 'bg-red-500');
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        };
        
        // ------------------------------------
        // 2. UIãƒ­ã‚¸ãƒƒã‚¯
        // ------------------------------------
        
        // è·¯ç·šå…¨ä½“ã®çŠ¶æ…‹å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ© (RIDDEN/COMPLETED)
        const handleOverallStatusChange = (lineName, newStatus) => {
            const status = parseInt(newStatus, 10);
            
            // ãƒ‡ãƒ¼ã‚¿åŒæœŸå¾Œã«å‡¦ç†ã‚’å®Ÿè¡Œ
            setupDataListener().then(() => {
                const newLineStatuses = JSON.parse(JSON.stringify(lineStatuses)); // deep clone

                if (!newLineStatuses[lineName]) {
                    newLineStatuses[lineName] = { overallStatus: RIDE_STATUS.NOT_RIDDEN, stations: {} };
                }

                if (status === RIDE_STATUS.NOT_RIDDEN) {
                     // è·¯ç·šå…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã€é§…ãƒ‡ãƒ¼ã‚¿ã‚‚ä¸€ç·’ã«å‰Šé™¤
                    delete newLineStatuses[lineName];
                } else {
                    // ä¹—è»Šæ¸ˆã¿ã¾ãŸã¯å®Œä¹—æ¸ˆã¿ã‚’è¨˜éŒ²
                    newLineStatuses[lineName].overallStatus = status;
                }
                
                saveDataToGas(newLineStatuses); // GASä¿å­˜
            }).catch(e => console.error("ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‰åŒæœŸã‚¨ãƒ©ãƒ¼:", e));
        };
        
        // é§…å˜ä½ã®åˆ©ç”¨å›æ•°å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
        const handleStationUsageChange = (lineName, stationName, newUsageStatus) => {
             const status = parseInt(newUsageStatus, 10);

             setupDataListener().then(() => {
                 const newLineStatuses = JSON.parse(JSON.stringify(lineStatuses)); // deep clone

                 // è·¯ç·šã‚¨ãƒ³ãƒˆãƒªãŒãªã„å ´åˆã¯ä½œæˆã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœªä¹—è»Š
                 if (!newLineStatuses[lineName]) {
                     newLineStatuses[lineName] = { overallStatus: RIDE_STATUS.NOT_RIDDEN, stations: {} };
                 }

                 // ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãŒãªã„å ´åˆã¯ä½œæˆ
                 if (!newLineStatuses[lineName].stations) {
                     newLineStatuses[lineName].stations = {};
                 }

                 if (status === USAGE_STATUS.NOT_ALIGHTED) {
                     // æœªé™è»Šã«æˆ»ã™å ´åˆã¯ã€é§…ã®åˆ©ç”¨å›æ•°ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                     delete newLineStatuses[lineName].stations[stationName];
                     
                     // è·¯ç·šå†…ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹é§…ãŒãªããªã£ãŸã‚‰ã€è·¯ç·šå…¨ä½“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚å‰Šé™¤
                     if (Object.keys(newLineStatuses[lineName].stations).length === 0) {
                         delete newLineStatuses[lineName];
                     }
                 } else {
                     // åˆ©ç”¨å›æ•°ã‚’è¨˜éŒ²
                     newLineStatuses[lineName].stations[stationName] = status;
                     
                     // é§…ã«åˆ©ç”¨å›æ•°ã‚’è¨˜éŒ²ã—ãŸã‚‰ã€è·¯ç·šå…¨ä½“ã‚’è‡ªå‹•çš„ã«ã€Œä¹—è»Šæ¸ˆã¿ã€ã«ã™ã‚‹
                     if (newLineStatuses[lineName].overallStatus === RIDE_STATUS.NOT_RIDDEN) {
                         newLineStatuses[lineName].overallStatus = RIDE_STATUS.RIDDEN;
                     }
                 }
                 
                 saveDataToGas(newLineStatuses); // GASä¿å­˜
             }).catch(e => console.error("ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‰åŒæœŸã‚¨ãƒ©ãƒ¼:", e));
        };
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å§”è­²
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('overall-status-button')) {
                const lineName = event.target.dataset.line;
                const newStatus = event.target.dataset.status;
                handleOverallStatusChange(lineName, newStatus);
            } else if (event.target.classList.contains('usage-status-button')) {
                const lineName = event.target.dataset.line;
                const stationName = event.target.dataset.station;
                const newUsageStatus = event.target.dataset.status;
                handleStationUsageChange(lineName, stationName, newUsageStatus);
            }
        });

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        const updateStats = () => {
            const totalLines = dummyRailroadData.features.length;
            
            const statuses = Object.values(lineStatuses).map(item => item.overallStatus);
            
            const riddenCount = statuses.filter(status => 
                status === RIDE_STATUS.RIDDEN || status === RIDE_STATUS.COMPLETED
            ).length;

            const completedCount = statuses.filter(status => 
                status === RIDE_STATUS.COMPLETED
            ).length;
            
            const riddenRate = totalLines > 0 ? ((riddenCount / totalLines) * 100).toFixed(1) : 0;
            const completedRate = totalLines > 0 ? ((completedCount / totalLines) * 100).toFixed(1) : 0;

            document.getElementById('totalLines').textContent = totalLines;
            document.getElementById('riddenCount').textContent = riddenCount;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('riddenRate').textContent = riddenRate + '%';
            document.getElementById('completedRate').textContent = completedRate + '%';
        };

        // è·¯ç·šãƒªã‚¹ãƒˆã®æç”»
        const renderLineList = (openLines = [], openCompanies = []) => {
            const container = document.getElementById('lineListContainer');
            if (!container) return;

            container.innerHTML = ''; // ã‚¯ãƒªã‚¢

            const sortedCompanies = Object.keys(groupedLines);

            sortedCompanies.forEach(company => {
                const features = groupedLines[company];
                
                // detailsè¦ç´ ï¼ˆä¼šç¤¾åã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ã‚’ä½œæˆ
                const companyDetails = document.createElement('details');
                companyDetails.className = 'group border-b border-gray-200 cursor-pointer';
                
                // ä¼šç¤¾ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
                companyDetails.open = openCompanies.length === 0 || openCompanies.includes(company); 

                
                // summaryè¦ç´ ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’ä½œæˆ
                const summary = document.createElement('summary');
                summary.className = 'flex justify-between items-center p-3 font-semibold text-gray-700 bg-gray-50 hover:bg-gray-100 transition duration-150 rounded-t-lg';
                summary.innerHTML = `
                    <span class="text-lg">${company} (${features.length}è·¯ç·š)</span>
                    <svg class="w-5 h-5 transition-transform duration-300 group-open:rotate-180 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                companyDetails.appendChild(summary);
                
                // è·¯ç·šãƒªã‚¹ãƒˆï¼ˆä¸­èº«ï¼‰ã‚’ä½œæˆ
                const lineUl = document.createElement('ul');
                lineUl.className = 'p-3 bg-white space-y-3';

                features.forEach(feature => {
                    const lineName = feature.properties.N02_005;
                    const stations = feature.properties.stations || [];
                    const currentLineData = lineStatuses[lineName] || { overallStatus: RIDE_STATUS.NOT_RIDDEN, stations: {} };
                    const currentOverallStatus = currentLineData.overallStatus;
                    
                    // --- ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ  ---
                    let currentPoints = 0;
                    let totalPoints = 0;

                    if (stations.length > 0) {
                        stations.forEach(stationName => {
                            // ç·å¾—ç‚¹ã¯ã€å„é§…ã§æœ€å¤§ã®ãƒã‚¤ãƒ³ãƒˆ (TEN_OR_MORE = 3pt) ã§è¨ˆç®—
                            totalPoints += USAGE_POINTS[USAGE_STATUS.TEN_OR_MORE]; 

                            // ç¾åœ¨ã®åˆ©ç”¨çŠ¶æ³ã‚’å–å¾—
                            const currentUsage = currentLineData.stations[stationName] || USAGE_STATUS.NOT_ALIGHTED;

                            // ç¾åœ¨ã®å¾—ç‚¹ã‚’åŠ ç®—
                            currentPoints += USAGE_POINTS[currentUsage];
                        });
                    }

                    const pointDisplay = `${currentPoints}/${totalPoints}pt`;
                    // --------------------------------

                    const lineLi = document.createElement('li');
                    lineLi.className = 'border border-gray-100 rounded-xl shadow-md overflow-hidden';
                    
                    // è·¯ç·šåã¨å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ (details)
                    const lineDetails = document.createElement('details');
                    lineDetails.className = 'line-details';
                    
                    // è·¯ç·šã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
                    if (openLines.includes(lineName)) {
                        lineDetails.open = true;
                    }

                    const lineSummary = document.createElement('summary');
                    lineSummary.className = 'flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-white hover:bg-gray-50 cursor-pointer';
                    
                    // è·¯ç·šåã¨ãƒã‚¤ãƒ³ãƒˆã‚’æ ¼ç´ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
                    const lineNameContainer = document.createElement('div');
                    lineNameContainer.className = 'flex items-center justify-between w-full sm:w-1/3 mb-2 sm:mb-0';

                    const lineNameSpan = document.createElement('span');
                    lineNameSpan.className = 'text-base font-bold text-gray-800 truncate mr-2'; // ãƒã‚¤ãƒ³ãƒˆã¨é›¢ã™
                    lineNameSpan.textContent = lineName;

                    const pointBadge = document.createElement('span');
                    pointBadge.className = 'text-sm font-semibold text-purple-700 bg-purple-100 px-2 py-0.5 rounded-full whitespace-nowrap flex-shrink-0'; // flex-shrink-0ã§ç¸®å°ã‚’é˜²ã
                    pointBadge.textContent = pointDisplay;

                    lineNameContainer.appendChild(lineNameSpan);
                    // ç·å¾—ç‚¹ãŒ0ã§ãªã„å ´åˆã«ã®ã¿ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º (stationsé…åˆ—ãŒãªã„è·¯ç·šãªã©)
                    if (totalPoints > 0) {
                        lineNameContainer.appendChild(pointBadge);
                    }


                    const overallButtonGroup = document.createElement('div');
                    overallButtonGroup.className = 'inline-flex rounded-md shadow-sm w-full sm:w-auto';
                    
                    // è·¯ç·šå…¨ä½“ã®çŠ¶æ…‹ãƒœã‚¿ãƒ³
                    [RIDE_STATUS.NOT_RIDDEN, RIDE_STATUS.RIDDEN, RIDE_STATUS.COMPLETED].forEach(status => {
                        const isSelected = currentOverallStatus === status;
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.textContent = STATUS_LABELS[status];
                        button.dataset.line = lineName;
                        button.dataset.status = status;
                        button.title = `${lineName}ã‚’${STATUS_LABELS[status]}ã«è¨­å®š`;
                        
                        let buttonClasses = `overall-status-button px-3 py-1 text-xs font-semibold transition-colors duration-150 focus:z-10 focus:ring-2 focus:ring-offset-2 rounded-lg `;

                        if (isSelected) {
                            buttonClasses += ` ${STATUS_COLORS[status].replace(/border-.*$/, 'border-2 border-current')} `;
                        } else {
                            buttonClasses += ` text-gray-600 bg-white border border-gray-300 hover:bg-gray-50`;
                        }
                        
                        if (status === RIDE_STATUS.NOT_RIDDEN) {
                            buttonClasses += ' rounded-r-none';
                        } else if (status === RIDE_STATUS.COMPLETED) {
                            buttonClasses += ' rounded-l-none -ml-px';
                        } else {
                            buttonClasses += ' rounded-none -ml-px';
                        }
                        
                        button.className = buttonClasses;
                        overallButtonGroup.appendChild(button);
                    });
                    
                    lineSummary.appendChild(lineNameContainer);
                    lineSummary.appendChild(overallButtonGroup);
                    lineDetails.appendChild(lineSummary);
                    
                    // --- é§…ãƒªã‚¹ãƒˆã®æç”» ---
                    if (stations.length > 0) {
                        const stationDiv = document.createElement('div');
                        stationDiv.className = 'p-3 pt-0 bg-gray-50 border-t border-gray-100';
                        
                        const stationListUl = document.createElement('ul');
                        stationListUl.className = 'space-y-2';

                        stations.forEach(stationName => {
                            const currentUsage = currentLineData.stations[stationName] || USAGE_STATUS.NOT_ALIGHTED;
                            
                            const stationLi = document.createElement('li');
                            stationLi.className = 'flex flex-col sm:flex-row sm:items-center justify-between p-2 bg-white rounded-md shadow-sm border border-gray-200';
                            
                            const stationNameSpan = document.createElement('span');
                            stationNameSpan.className = 'text-sm font-medium text-gray-700 w-full sm:w-1/3 mb-1 sm:mb-0';
                            stationNameSpan.textContent = stationName;

                            const usageButtonGroup = document.createElement('div');
                            usageButtonGroup.className = 'inline-flex rounded-md shadow-sm w-full sm:w-auto';
                            
                            // é§…å˜ä½ã®åˆ©ç”¨å›æ•°ãƒœã‚¿ãƒ³
                            [USAGE_STATUS.NOT_ALIGHTED, USAGE_STATUS.ONCE, USAGE_STATUS.LESS_THAN_TEN, USAGE_STATUS.TEN_OR_MORE].forEach(status => {
                                const isSelected = currentUsage === status;
                                const button = document.createElement('button');
                                button.type = 'button';
                                button.textContent = USAGE_LABELS[status];
                                button.dataset.line = lineName;
                                button.dataset.station = stationName;
                                button.dataset.status = status;
                                button.title = `${stationName}ã®åˆ©ç”¨å›æ•°ã‚’${USAGE_LABELS[status]}ã«è¨­å®š`;

                                let buttonClasses = `usage-status-button px-2 py-1 text-xs transition-colors duration-150 focus:z-10 focus:ring-2 focus:ring-offset-2 rounded-lg `;

                                if (isSelected) {
                                    buttonClasses += ` ${USAGE_COLORS[status]} font-bold border-2 border-current`;
                                } else {
                                    buttonClasses += ` text-gray-600 bg-white border border-gray-300 hover:bg-gray-50`;
                                }
                                
                                if (status === USAGE_STATUS.NOT_ALIGHTED) {
                                    buttonClasses += ' rounded-r-none';
                                } else if (status === USAGE_STATUS.TEN_OR_MORE) {
                                    buttonClasses += ' rounded-l-none -ml-px';
                                } else {
                                    buttonClasses += ' rounded-none -ml-px';
                                }
                                
                                button.className = buttonClasses;
                                usageButtonGroup.appendChild(button);
                            });

                            stationLi.appendChild(stationNameSpan);
                            stationLi.appendChild(usageButtonGroup);
                            stationListUl.appendChild(stationLi);
                        });
                        
                        stationDiv.appendChild(stationListUl);
                        lineDetails.appendChild(stationDiv);
                    }
                    
                    lineLi.appendChild(lineDetails);
                    lineUl.appendChild(lineLi);
                });
                
                companyDetails.appendChild(lineUl);
                container.appendChild(companyDetails);
            });
        };

        // UIå…¨ä½“ï¼ˆãƒªã‚¹ãƒˆã¨çµ±è¨ˆæƒ…å ±ï¼‰ã®æ›´æ–°
        const updateUI = () => {
            updateStats();

            // --- 1. ç¾åœ¨é–‹ã„ã¦ã„ã‚‹è·¯ç·š/ä¼šç¤¾ã‚’è¨˜æ†¶ ---
            const openLines = new Set();
            document.querySelectorAll('#lineListContainer details.line-details').forEach(detail => {
                if (detail.open) {
                    const lineButton = detail.querySelector('.overall-status-button');
                    if (lineButton) {
                        openLines.add(lineButton.dataset.line);
                    }
                }
            });
            
            const openCompanies = new Set();
             document.querySelectorAll('#lineListContainer > details.group').forEach(detail => {
                 if (detail.open) {
                     const summarySpan = detail.querySelector('summary > span:first-child');
                     if (summarySpan) {
                         const companyName = summarySpan.textContent.replace(/\s*\(\d+è·¯ç·š\)/, '').trim();
                         openCompanies.add(companyName);
                     }
                 }
             });
            // --- è¨˜æ†¶ã“ã“ã¾ã§ ---
            
            // è¨˜æ†¶ã—ãŸé–‹é–‰çŠ¶æ…‹ã‚’æ¸¡ã—ã¦å†æç”»
            renderLineList(Array.from(openLines), Array.from(openCompanies));
        };

        // ------------------------------------
        // 3. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)
        // ------------------------------------
        const alertMessage = (message, colorClass) => {
            const alertBox = document.getElementById('customAlert');
            alertBox.textContent = message;
            alertBox.className = `p-3 rounded-lg text-white font-semibold text-center mt-4 ${colorClass}`;
            alertBox.classList.remove('hidden');
            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 5000);
        };

        // ------------------------------------
        // 4. å…¨ä½“ã®åˆæœŸåŒ–
        // ------------------------------------
        const initAppAndData = () => {
            document.getElementById('userIdDisplay').textContent = userId;
            groupedLines = groupLinesByCompany();
            setupDataListener(); // GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        }
        
        window.onload = initAppAndData;
    </script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col font-sans">
        <header class="bg-white shadow-md p-4 sticky top-0 z-10">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7-8h14a2 2 0 012 2v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4a2 2 0 012-2z" />
                </svg>
                é‰„é“çµŒçœŒå€¤ãƒãƒƒãƒ— (GASé€£æºç‰ˆ)
            </h1>
            <p class="text-sm text-gray-500 mt-1">è·¯ç·šã¯ä¹—è»Šãƒ»å®Œä¹—ã€é§…ã¯åˆ©ç”¨å›æ•°ã‚’è¨˜éŒ²ã§ãã¾ã™ã€‚</p>
            <div class="text-xs mt-2 p-1 bg-gray-100 rounded-md">
                <span class="font-semibold text-gray-600">ã‚ãªãŸã®ãƒ­ãƒ¼ã‚«ãƒ«ID:</span> <span id="userIdDisplay">...</span>
            </div>
        </header>

        <main class="flex-grow p-4">
            <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºé ˜åŸŸ -->
            <div id="customAlert" class="hidden max-w-4xl mx-auto"></div>

            <!-- çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4 grid grid-cols-2 md:grid-cols-5 gap-4 max-w-4xl mx-auto">
                <div class="text-center md:border-r border-gray-200">
                    <p class="text-xs text-gray-500">ç·è·¯ç·šæ•°</p>
                    <p id="totalLines" class="text-xl md:text-2xl font-bold text-gray-800">0</p>
                </div>
                <div class="text-center md:border-r border-gray-200">
                    <p class="text-xs text-gray-500">ä¹—è»Šæ¸ˆã¿è·¯ç·šæ•°</p>
                    <p id="riddenCount" class="text-xl md:text-3xl font-extrabold text-blue-600">0</p>
                </div>
                <div class="text-center md:border-r border-gray-200">
                    <p class="text-xs text-gray-500">ä¹—è»Šé”æˆç‡</p>
                    <p id="riddenRate" class="text-xl md:text-2xl font-bold text-blue-700">0.0%</p>
                </div>
                <div class="text-center md:border-r border-gray-200">
                    <p class="text-xs text-gray-500">å®Œä¹—æ¸ˆã¿è·¯ç·šæ•°</p>
                    <p id="completedCount" class="text-xl md:text-3xl font-extrabold text-emerald-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500">å®Œä¹—é”æˆç‡</p>
                    <p id="completedRate" class="text-xl md:text-2xl font-bold text-emerald-700">0.0%</p>
                </div>
            </div>

            <!-- è·¯ç·šãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
            <div class="w-full max-w-4xl mx-auto rounded-xl shadow-2xl bg-white overflow-hidden">
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
                <div id="loadingIndicator" class="p-6 flex items-center justify-center border-b border-gray-100">
                    <div class="flex flex-col items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-emerald-700">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                
                <!-- è·¯ç·šãƒªã‚¹ãƒˆã®æç”»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ -->
                <div id="lineListContainer" class="p-4">
                    <!-- JavaScriptã«ã‚ˆã£ã¦è·¯ç·šãƒªã‚¹ãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <p class="text-center text-sm text-gray-500 mt-4 max-w-4xl mx-auto">
                è·¯ç·šãƒ»é§…ãƒ‡ãƒ¼ã‚¿ã¯ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ç°¡ç•¥åŒ–ã•ã‚ŒãŸãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚
            </p>

        </main>

        <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-4">
            <p>é‰„é“çµŒçœŒå€¤ãƒãƒƒãƒ— - Powered by HTML/JS & Google Apps Script</p>
        </footer>
    </div>
</body>
</html>
